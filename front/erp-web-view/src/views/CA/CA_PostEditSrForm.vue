<template style="margin-top:-30px;">
  <v-container fluid class="pr-0 pl-0 pt-0">

    <br>

    <v-row no-gutters class="search-row top-row">
      <v-col class="search-col input-width">
        <div class="label-box colNm">
          <span class="required-star">*</span> ì œëª©
        </div>
        <v-text-field v-model="inquiry.sub" variant="outlined" density="compact" hide-details
          class="input-area title-field" />
      </v-col>
    </v-row>

    <v-row no-gutters class="search-row middle-row">
      <v-col class="search-col input-width">
        <div class="label-box colNm"><span class="required-star">*</span>ì—…ë¬´ëª…</div>
        <v-text-field v-model="inquiry.taskName" variant="outlined" density="compact" hide-details
          class="input-area"></v-text-field>
      </v-col>
    </v-row>

    <v-row no-gutters class="search-row middle-row">
      <v-col class="search-col input-width">
        <div class="label-box colNm"><span class="required-star">*</span>í˜‘ì¡°</div>
        <v-text-field v-model="inquiry.help" variant="outlined" density="compact" hide-details
          class="input-area"></v-text-field>
      </v-col>
    </v-row>

    <v-row no-gutters class="search-row middle-row">
      <v-col class="search-col input-width">
        <div class="label-box colNm"><span class="required-star">*</span>ê°œë°œ(ë³€ê²½) í•„ìš”ì„±</div>
        <v-text-field v-model="inquiry.necessity" variant="outlined" density="compact" hide-details
          class="input-area"></v-text-field>
      </v-col>
    </v-row>

    <v-row no-gutters class="search-row middle-row">
      <v-col class="search-col input-width">
        <div class="label-box colNm"><span class="required-star">*</span>ê¸°ëŒ€íš¨ê³¼</div>
        <v-text-field v-model="inquiry.effect" variant="outlined" density="compact" hide-details
          class="input-area"></v-text-field>
      </v-col>
    </v-row>

    <v-row no-gutters class="search-row middle-row">
      <v-col class="search-col input-width">
        <div class="label-box colNm"><span class="required-star">*</span>ê°œë°œ(ë³€ê²½) ëª¨ë“ˆ</div>
        <v-text-field v-model="inquiry.module" variant="outlined" density="compact" hide-details
          class="input-area"></v-text-field>
      </v-col>
    </v-row>

    <v-row no-gutters class="search-row middle-row" style="height:200px;">
      <v-col class="search-col request-period">
        <div class="label-box colNm"><span class="required-star">*</span>ê°œë°œ(ë³€ê²½)<br />ì—…ë¬´ë‚´ìš©</div>
      </v-col>

      <v-col style="border-right: 1px solid #e0e0e0;">
        <div>
          <div class="sub-label">ë³€ê²½ì „</div>
          <v-textarea v-model="inquiry.beforeTaskContent" variant="outlined" density="compact" hide-details
            class="input-area-L"></v-textarea>
        </div>
      </v-col>

      <!-- ë³€ê²½í›„ -->
      <v-col>
        <div>
          <div class="sub-label">ë³€ê²½í›„</div>
          <v-textarea v-model="inquiry.afterTaskContent" variant="outlined" density="compact" hide-details
            class="input-area-L"></v-textarea>
        </div>
      </v-col>
    </v-row>

    <v-row no-gutters class="search-row middle-row">
      <v-col class="search-col input-width-half">
        <div class="label-box colNm">
          <span class="required-star">*</span>ì‚¬ìš©ë¶€ì„œ
        </div>
        <v-text-field v-model="inquiry.useDept" variant="outlined" density="compact" hide-details class="input-area"
          style="width: 100%;">
        </v-text-field>
      </v-col>

      <v-col class="search-col input-width-half">
        <div class="label-box colNm">ì²¨ë¶€ë¬¸ì„œ</div>
        <v-text-field v-model="inquiry.attachDoc" variant="outlined" density="compact" hide-details class="input-area"
          style="width: 100%;"></v-text-field>
      </v-col>
    </v-row>

    <v-row no-gutters class="search-row middle-row">
      <v-col class="search-col input-width-half">
        <div class="label-box colNm"><span class="required-star">*</span>ì˜ë¢°ì¼ì</div>

        <VueDatePicker class="date-picker ml-1" :month-picker="false" preview-format="yyyy-MM-dd"
          v-model="inquiry.requestDate" :teleport="true" :enable-time-picker="false" auto-apply locale="ko"
          format="yyyy-MM-dd" :week-start="1" :allowed-dates="allowedDates"
          @update:model-value="requestDateMenu = false" v-model:open="datePickerOpen" :clearable="false"
          :text-input="false" />

        <!-- <v-menu v-model="requestDateMenu" :close-on-content-click="false" transition="scale-transition" offset-y
          min-width="auto">
          <template v-slot:activator="{ props }">
            <div class="date-field-wrapper" v-bind="props"
              style="display: flex; align-items: center; gap: 4px; width: 200px; ">
              <v-text-field v-model="formattedRequestDate" class="input-area" density="compact" hide-details readonly
                variant="outlined" />
              <v-icon size="23" color="#7A7A7A">mdi-calendar-search</v-icon>
            </div>
          </template>

<v-date-picker v-model="inquiry.requestDate" @update:model-value="requestDateMenu = false" locale="ko-KR" elevation="1"
  color="blue" width="310" first-day-of-week="1" show-adjacent-months scrollable :allowed-dates="allowedDates" />
</v-menu> -->
      </v-col>


      <v-col class="search-col input-width-half">
        <div class="label-box colNm">ì ‘ìˆ˜ì¼ì</div>
        <VueDatePicker class="date-picker ml-1" :month-picker="false" preview-format="yyyy-MM-dd"
          v-model="inquiry.acceptDate" :teleport="false" position="top" :enable-time-picker="false" auto-apply
          locale="ko" format="yyyy-MM-dd" :week-start="1" :allowed-dates="allowedDates"
          @update:model-value="acceptDateMenu = false" v-model:open="datePickerOpen" :clearable="false"
          :text-input="false" />

        <!-- <v-menu v-model="acceptDateMenu" :close-on-content-click="false" transition="scale-transition" offset-y
          min-width="auto">
          <template v-slot:activator="{ props }">
            <div class="date-field-wrapper" v-bind="props"
              style="display: flex; align-items: center; gap: 4px; width: 200px; ">
              <v-text-field v-model="formattedAcceptDate" class="input-area" density="compact" hide-details readonly
                variant="outlined" />
              <v-icon size="23" color="#7A7A7A">mdi-calendar-search</v-icon>
            </div>
          </template>

          <v-date-picker v-model="inquiry.acceptDate" @update:model-value="acceptDateMenu = false" locale="ko-KR"
            elevation="1" color="blue" width="300" first-day-of-week="1" show-adjacent-months scrollable
            :allowed-dates="allowedDates" />
        </v-menu> -->
      </v-col>
    </v-row>

    <v-row no-gutters class="search-row middle-row">
      <v-col class="search-col input-width-half">
        <div class="label-box colNm"><span class="required-star">*</span>ì™„ë£Œìš”ì²­ì¼ì</div>
        <VueDatePicker class="date-picker ml-1" :month-picker="false" preview-format="yyyy-MM-dd"
          v-model="inquiry.completeRequestDate" :teleport="false" position="top" :enable-time-picker="false" auto-apply
          locale="ko" format="yyyy-MM-dd" :week-start="1" :allowed-dates="allowedDates"
          @update:model-value="completeRequestDateMenu = false" v-model:open="datePickerOpen" :clearable="false"
          :text-input="false" />

        <!-- <v-menu v-model="completeRequestDateMenu" :close-on-content-click="false" transition="scale-transition" offset-y
          min-width="auto">
          <template v-slot:activator="{ props }">
            <div class="date-field-wrapper" v-bind="props"
              style="display: flex; align-items: center; gap: 4px; width: 200px; ">
              <v-text-field v-model="formattedCompleteRequestDate" class="input-area" density="compact" hide-details
                readonly variant="outlined" />
              <v-icon size="23" color="#7A7A7A">mdi-calendar-search</v-icon>
            </div>
          </template>

          <v-date-picker v-model="inquiry.completeRequestDate" @update:model-value="completeRequestDateMenu = false"
            locale="ko-KR" elevation="1" color="blue" width="300" first-day-of-week="1" show-adjacent-months scrollable
            :allowed-dates="allowedDates" /> 
        </v-menu> -->
      </v-col>

      <v-col class="search-col" style="max-width:600px;">
        <div class="label-box colNm">ì™„ë£Œì¼ì</div>
        <VueDatePicker class="date-picker ml-1 mt-1" :month-picker="false" preview-format="yyyy-MM-dd"
          v-model="inquiry.completeDate" :teleport="false" position="top" :enable-time-picker="false" auto-apply
          locale="ko" format="yyyy-MM-dd" :week-start="1" :allowed-dates="allowedDates"
          @update:model-value="completeDateMenu = false" v-model:open="datePickerOpen" :clearable="false"
          :text-input="false" />

        <!-- <v-menu v-model="completeDateMenu" :close-on-content-click="false" transition="scale-transition" offset-y
          min-width="auto">
          <template v-slot:activator="{ props }">
            <div class="date-field-wrapper" v-bind="props"
              style="display: flex; align-items: center; gap: 4px; width: 200px; ">
              <v-text-field v-model="formattedCompleteDate" class="input-area" density="compact" hide-details readonly
                variant="outlined" />
              <v-icon size="23" color="#7A7A7A">mdi-calendar-search</v-icon>
            </div>
          </template>

          <v-date-picker v-model="inquiry.completeDate" @update:model-value="completeDateMenu = false" locale="ko-KR"
            elevation="1" color="blue" width="300" first-day-of-week="1" show-adjacent-months scrollable
            :allowed-dates="allowedDates" />
        </v-menu> -->
      </v-col>
    </v-row>

    <v-row no-gutters class="search-row middle-row">
      <v-col class="search-col input-width">
        <div class="label-box colNm">ê¸°íƒ€</div>
        <v-text-field v-model="inquiry.etc" variant="outlined" density="compact" hide-details
          class="input-area"></v-text-field>
      </v-col>
    </v-row>

    <v-row no-gutters class="search-row bottom-row">
      <v-col class="search-col input-width">
        <div class="label-box colNm">ì²¨ë¶€ëª©ë¡</div>
        <v-file-input style="display: none;" ref="fileInput" class="manager-search flex-grow-1" v-model="newFiles"
          :rules="fileRules" accept="image/png, image/jpeg, application/pdf" label="íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”" density="compact"
          variant="outlined" prepend-icon="" multiple :loading="isFileLoading" hide-details
          @change="handleFileChange"></v-file-input>

        <v-btn variant="flat" color="#3A70B1" class="file-btn mt-2 mb-2 ml-2 mr-2 white-text d-flex align-center"
          size="small" @click="openFileSelector">
          <v-icon size="default" class="mr-1">mdi-file-upload</v-icon>
          ì²¨ë¶€
        </v-btn>

        <!-- ì„ íƒëœ íŒŒì¼ ëª©ë¡ (ì•„ì§ ì—…ë¡œë“œë˜ì§€ ì•Šì€ íŒŒì¼) -->
        <div v-if="selectedFiles.length > 0" class="selected-files ml-5 mt-2 mb-2">
          <div class="selected-files-container">
            <div v-for="(file, index) in selectedFiles" :key="index" class="selected-files-item">
              <div class="file-info">
                <div class="file-name text-body-1">{{ file.name }}</div>
                <div class="file-size text-body-2 text-grey">{{ formatFileSize(file.size) }}</div>
              </div>
              <v-btn class="ml-3" icon="mdi-delete" variant="text" color="#E44532" density="compact"
                @click="removeSelectedFile(index)"></v-btn>
            </div>
          </div>
        </div>

        <!-- ì—…ë¡œë“œëœ íŒŒì¼ -->
        <div v-if="uploadedFiles.length > 0" class="selected-files ml-5 mt-2 mb-2">
          <div class="selected-files-container">
            <div v-for="(file, index) in uploadedFiles" :key="index" class="selected-files-item">
              <div class="file-info">
                <div class="file-name text-body-1">{{ file.name }}</div>
                <div class="file-size text-body-2 text-grey">{{ formatFileSize(file.size) }}</div>
              </div>
              <v-btn class="ml-3" icon="mdi-delete" variant="text" color="#E44532" density="compact"
                @click="markFileForDeletion(index, file)"></v-btn>
            </div>
          </div>
        </div>
      </v-col>

    </v-row>

    <v-row class="mt-5">
      <v-col cols="12" class="d-flex justify-center">
        <v-btn variant="flat" color="grey darken-2" class="custom-btn mx-2" size="large" @click="moveSrDetail">
          <v-icon size="default" class="mr-1">mdi-close</v-icon>
          ì·¨ì†Œ
        </v-btn>
        <v-btn variant="flat" color="primary" class="custom-btn mx-2" size="large" @click="submitRequest">
          <v-icon size="default" class="mr-1">mdi-check</v-icon>
          ì €ì¥
        </v-btn>
      </v-col>
    </v-row>
  </v-container>
</template>



<script>
import apiClient from '@/api';
import dayjs from 'dayjs'
import utc from 'dayjs/plugin/utc'
import timezone from 'dayjs/plugin/timezone'
import { inject, onMounted } from 'vue';
import VueDatePicker from '@vuepic/vue-datepicker';
import '@vuepic/vue-datepicker/dist/main.css';


dayjs.extend(utc)
dayjs.extend(timezone)
dayjs.tz.setDefault('Asia/Seoul')  // KST ê¸°ì¤€ ì„¤ì •

export default {
  components: {
    VueDatePicker
  },
  props: {
    receivedSeq: {
      type: [Number, String],
      required: false
    },
    userId: JSON.parse(localStorage.getItem("userInfo"))?.id || null
  },
  setup() {
    const extraBreadcrumb = inject('extraBreadcrumb', null);
    const listButtonLink = inject('listButtonLink', null);
    onMounted(() => {
      if (extraBreadcrumb) {
        extraBreadcrumb.value = 'SR ìš”ì²­ì„œ ì‘ì„±';  // ğŸ”¥ ì¶”ê°€í•˜ê³  ì‹¶ì€ ê°’
      }

      if (listButtonLink) {
        listButtonLink.value = '/views/CA/CA1000_10';  // ğŸ”¥ í˜„ì¬ í˜ì´ì§€ì— ë§ëŠ” "ëª©ë¡" ê²½ë¡œ ì„¤ì •
      }
    });

    return {};
  },
  unmounted() { // â— ì»´í¬ë„ŒíŠ¸ê°€ ì–¸ë§ˆìš´íŠ¸ë  ë•Œ
    const listButtonLink = inject('listButtonLink', null);
    if (listButtonLink) {
      listButtonLink.value = null; // ğŸ”¥ í˜ì´ì§€ ë²—ì–´ë‚  ë•Œ ëª©ë¡ë²„íŠ¼ ì—†ì• ê¸°
    }

    const extraBreadcrumb = inject('extraBreadcrumb', null);
    if (extraBreadcrumb) {
      extraBreadcrumb.value = null; // í˜ì´ì§€ ë²—ì–´ë‚  ë•Œ ëª©ë¡ë²„íŠ¼ ì—†ì• ê¸°
    }
  },
  data() {
    return {
      userInfo: null,       //ì‚¬ìš©ì ID
      requestDateMenu: false,
      acceptDateMenu: false,
      completeRequestDateMenu: false,
      completeDateMenu: false,
      step: 1,
      selectedStatus: '', // ì¶”ê°€ëœ ìƒíƒœ ë³€ìˆ˜
      inquiry: {
        sub: "",
        context: "",
        taskName: "",
        help: "",
        necessity: "",
        effect: "",
        module: "",
        beforeTaskContent: "",
        afterTaskContent: "",
        useDept: "",
        attachDoc: "",
        requestDate: null,
        acceptDate: null,
        completeRequestDate: null,
        completeDate: null,
        etc: "",
        uid: "",
        usem: "",
        dpId: "",
        dpDn: "",
        manager: "",
        division: "",
        processState: ""
      },
      management: {
        PROGRESS: ""
      },
      progressStatuses: [],
      newFiles: [],
      selectedFiles: [],
      uploadedFiles: [],
      deleteFileList: [], //ì‚­ì œí•  íŒŒì¼ ì •ë³´
      showOverwriteDialog: false,
      duplicateFiles: [],
      pendingFiles: [],
      fileRules: [
        value => {
          return !value || !value.length || value[0].size < 5000000 || 'íŒŒì¼ í¬ê¸°ëŠ” 5MB ì´í•˜ì—¬ì•¼ í•©ë‹ˆë‹¤.';
        },
      ],

    };
  },
  methods: {
    async fetchRequireDetail() {
      try {
        const response = await apiClient.get("/api/require/detail", {
          params: { seq: this.receivedSeq }
        });

        const data = response.data;

        if (!data) {
          console.warn("â— ë¶ˆëŸ¬ì˜¨ ë°ì´í„° ì—†ìŒ");
          return;
        }

        // âœ… inquiry ê°’ ë®ì–´ì“°ê¸° (í•„ë“œ ìœ ì§€)
        Object.assign(this.inquiry, {
          sub: data?.sub || "",
          taskName: data?.taskName || "",
          help: data?.help || "",
          necessity: data?.necessity || "",
          effect: data?.effect || "",
          module: data?.module || "",
          beforeTaskContent: data?.beforeTaskContent || "",
          afterTaskContent: data?.afterTaskContent || "",
          useDept: data?.useDept || "",
          attachDoc: data?.attachDoc || "",
          requestDate: data?.requestDate ? new Date(data.requestDate) : null,
          acceptDate: data?.acceptDate ? new Date(data.acceptDate) : null,
          completeRequestDate: data?.completeRequestDate ? new Date(data.completeRequestDate) : null,
          completeDate: data?.completeDate ? new Date(data.completeDate) : null,
          etc: data?.etc || "",
          uid: data?.uid || "",
          usem: data?.usem || "",
          dpId: data?.dpId || "",
          dpDn: data?.dpDn || "",
          manager: data?.manager || "",
          division: data?.division || "",
          processState: data?.processState || "",
        });

        //ì²¨ë¶€íŒŒì¼ ë¦¬ìŠ¤íŠ¸ ë¶ˆëŸ¬ì˜¤ê¸°
        try {
          const fileList = await apiClient.get("/api/file-attach/fileList", {
            params: { seq: this.receivedSeq, boardType: 'CA1000_10' }
          });

          this.uploadedFiles = Array.isArray(fileList.data)
            ? fileList.data
              .filter(file => file && file.fileName)
              .map(file => ({
                name: file.fileName,
                size: file.fileSize,
                type: file.fileType || '',
                seq: file.seq
              }))
            : [];


        } catch (error) {
          console.error("ì˜¤ë¥˜ ë°œìƒ:", error);
        }

      } catch (error) {
        console.error("ìš”êµ¬ì‚¬í•­ ë¶ˆëŸ¬ì˜¤ê¸° ì˜¤ë¥˜:", error);
      }
    },
    async submitRequest() {
      if (confirm("ì €ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {

        if (!this.inquiry.sub || this.inquiry.sub.trim() === '') {
          alert("ì œëª©ì€ í•„ìˆ˜ í•­ëª©ì…ë‹ˆë‹¤.");
          return;
        }
        if (!this.inquiry.taskName || this.inquiry.taskName.trim() === '') {
          alert("ì—…ë¬´ëª…ì€ í•„ìˆ˜ í•­ëª©ì…ë‹ˆë‹¤.");
          return;
        }
        if (!this.inquiry.help || this.inquiry.help.trim() === '') {
          alert("í˜‘ì¡°ëŠ” í•„ìˆ˜ í•­ëª©ì…ë‹ˆë‹¤.");
          return;
        }
        if (!this.inquiry.necessity || this.inquiry.necessity.trim() === '') {
          alert("ê°œë°œ(ë³€ê²½) í•„ìš”ì„±ì€ í•„ìˆ˜ í•­ëª©ì…ë‹ˆë‹¤.");
          return;
        }
        if (!this.inquiry.effect || this.inquiry.effect.trim() === '') {
          alert("ê¸°ëŒ€íš¨ê³¼ëŠ” í•„ìˆ˜ í•­ëª©ì…ë‹ˆë‹¤.");
          return;
        }
        if (!this.inquiry.module || this.inquiry.module.trim() === '') {
          alert("ê°œë°œ(ë³€ê²½) ëª¨ë“ˆì€ í•„ìˆ˜ í•­ëª©ì…ë‹ˆë‹¤.");
          return;
        }
        if (!this.inquiry.beforeTaskContent || this.inquiry.beforeTaskContent.trim() === '' || !this.inquiry.afterTaskContent || this.inquiry.afterTaskContent.trim() === '') {
          alert("ê°œë°œ(ë³€ê²½) ì—…ë¬´ë‚´ìš©ì€ í•„ìˆ˜ í•­ëª©ì…ë‹ˆë‹¤.");
          return;
        }
        if (!this.inquiry.useDept || this.inquiry.useDept.trim() === '') {
          alert("ì‚¬ìš©ë¶€ì„œëŠ” í•„ìˆ˜ í•­ëª©ì…ë‹ˆë‹¤.");
          return;
        }
        if (!this.inquiry.requestDate) {
          alert("ì˜ë¢°ì¼ìëŠ” í•„ìˆ˜ í•­ëª©ì…ë‹ˆë‹¤.");
          return;
        }
        if (!this.inquiry.completeRequestDate) {
          alert("ì™„ë£Œìš”ì²­ì¼ìëŠ” í•„ìˆ˜ í•­ëª©ì…ë‹ˆë‹¤.");
          return;
        }

        try {
          const param = {
            seq: this.receivedSeq,
            sub: this.inquiry.sub,                        //ì œëª©
            taskName: this.inquiry.taskName,              //ì—…ë¬´ëª…
            help: this.inquiry.help,              //í˜‘ì¡°
            necessity: this.inquiry.necessity,    //ê°œë°œ(ë³€ê²½) í•„ìš”ì„±
            effect: this.inquiry.effect,          //ê¸°ëŒ€íš¨ê³¼
            module: this.inquiry.module,          //ê°œë°œ(ë³€ê²½) ëª¨ë“ˆ
            beforeTaskContent: this.inquiry.beforeTaskContent,    //ê°œë°œ(ë³€ê²½) ì—…ë¬´ë‚´ìš© - ë³€ê²½ì „
            afterTaskContent: this.inquiry.afterTaskContent,    //ê°œë°œ(ë³€ê²½) ì—…ë¬´ë‚´ìš© - ë³€ê²½í›„
            useDept: this.inquiry.useDept,        //ì‚¬ìš©ë¶€ì„œ
            attachDoc: this.inquiry.attachDoc,    //ì²¨ë¶€ë¬¸ì„œ
            requestDate: this.inquiry.requestDate,//ì˜ë¢°ì¼ì
            acceptDate: this.inquiry.acceptDate,  //ì ‘ìˆ˜ì¼ì
            completeRequestDate: this.inquiry.completeRequestDate,    //ì™„ë£Œìš”ì²­ì¼ì
            completeDate: this.inquiry.completeDate,                  //ì™„ë£Œì¼ì
            etc: this.inquiry.etc,                  //ê¸°íƒ€
          };

          const boardSeq = this.receivedSeq; // ë“±ë¡ëœ ê²Œì‹œê¸€ì˜ seq

          const fileAttachPromises = this.selectedFiles.map(async (file) => {
            try {
              // íŒŒì¼ëª…ì€ ê²Œì‹œë¬¼ ê¸°ì¤€ìœ¼ë¡œ ì¤‘ë³µ ê´€ë¦¬í•¨
              const fileName = `${boardSeq}_${file.name}`;

              // ì›ë³¸ íŒŒì¼ ê°ì²´ì˜ ì´ë¦„ ë³€ê²½
              const modifiedFile = new File([file], fileName, {
                type: file.type,
                lastModified: file.lastModified
              });

              const fileAttachData = {
                boardSeq: boardSeq,
                fileName: fileName,
                fileSize: modifiedFile.size,
                fileType: modifiedFile.type,
                boardType: 'CA1000_10'
              };

              // FileAttach í…Œì´ë¸” INSERT API í˜¸ì¶œ
              const attachResponse = await apiClient.post('/api/file-attach/insert', fileAttachData);

              // íŒŒì¼ì„œë²„ ì—…ë¡œë“œ API í˜¸ì¶œ
              const additionalResponse = await this.processUpload([modifiedFile]);

              return {
                fileName: file.name,
                status: 'success',
                attachResponse,
                additionalResponse
              };
            } catch (error) {
              console.error(`íŒŒì¼ ${file.name} ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜:`, error);
              return {
                fileName: file.name,
                status: 'error',
                error: error.message
              };
            }
          });

          if (this.deleteFileList.length > 0) {
            for (const { file } of this.deleteFileList) {
              await this.removeFile(file);
            }
            this.deleteFileList = [];
          }

          // ëª¨ë“  íŒŒì¼ ì²¨ë¶€ ë° ì¶”ê°€ API í˜¸ì¶œì„ ë™ì‹œì— ì‹¤í–‰
          const responses = await Promise.all(fileAttachPromises);

          // ê²°ê³¼ ë¶„ì„
          // const successFiles = responses.filter(response => response.status === 'success');
          const errorFiles = responses.filter(response => response.status === 'error');

          // ì‹¤íŒ¨í•œ íŒŒì¼ì´ ìˆìœ¼ë©´ ì‚¬ìš©ìì—ê²Œ ì•Œë¦¼
          if (errorFiles.length > 0) {
            this.errorMessages = errorFiles.map(file => `${file.fileName}: ${file.error}`);
            this.showError = true;
          }

          // API ìš”ì²­: ëŒ“ê¸€ DBì— ì €ì¥
          await apiClient.post("/api/require/updateSrForm", param);
          alert("ì €ì¥í•˜ì˜€ìŠµë‹ˆë‹¤.");

          this.$router.push({
            name: 'CA_PostDetailSrForm',
            params: { receivedSeq: this.receivedSeq }
          })

        } catch (error) {
          alert("ì €ì¥ì— ì‹¤íŒ¨í•˜ì˜€ìŠµë‹ˆë‹¤. ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”.");
        }
      }
    },
    moveSrDetail() {
      if (confirm("ìˆ˜ì •ì„ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
        this.$router.push({
          name: 'CA_PostDetailSrForm',
          params: { receivedSeq: this.receivedSeq }
        })
      }
    },
    // íŒŒì¼ íƒ€ì…ì— ë”°ë¥¸ ì•„ì´ì½˜ ë°˜í™˜
    getFileIcon(fileType) {
      if (fileType.includes('image')) {
        return 'mdi-file-image';
      } else if (fileType.includes('pdf')) {
        return 'mdi-file-pdf';
      } else {
        return 'mdi-file-document';
      }
    },

    // íŒŒì¼ í¬ê¸° í¬ë§·
    formatFileSize(size) {
      if (size < 1024) {
        return size + ' B';
      } else if (size < 1024 * 1024) {
        return (size / 1024).toFixed(2) + ' KB';
      } else {
        return (size / (1024 * 1024)).toFixed(2) + ' MB';
      }
    },

    // íŒŒì¼ ì„ íƒ ë³€ê²½ ì²˜ë¦¬
    handleFileChange() {
      // íŒŒì¼ì€ v-modelì— ë°”ì¸ë”©ëœ newFilesì—ì„œ ê°€ì ¸ì˜µë‹ˆë‹¤
      const files = this.newFiles;

      if (!files || (Array.isArray(files) && files.length === 0)) {
        return;
      }

      if (Array.isArray(files)) {
        files.forEach((file) => {
          // ì¤‘ë³µ íŒŒì¼ ê²€ì‚¬ (selectedFiles ë‚´ì—ì„œ)
          const existingSelectedIndex = this.selectedFiles.findIndex(f => f.name === file.name);
          if (existingSelectedIndex !== -1) {
            // ì„ íƒëœ íŒŒì¼ ëª©ë¡ì—ì„œ ì¤‘ë³µëœ íŒŒì¼ êµì²´
            this.selectedFiles.splice(existingSelectedIndex, 1, file);
          } else {
            // ìƒˆ íŒŒì¼ ì¶”ê°€
            this.selectedFiles.push(file);
          }
        });
      } else {
        // ì¤‘ë³µ íŒŒì¼ ê²€ì‚¬ (selectedFiles ë‚´ì—ì„œ)
        const existingSelectedIndex = this.selectedFiles.findIndex(f => f.name === files.name);
        if (existingSelectedIndex !== -1) {
          // ì„ íƒëœ íŒŒì¼ ëª©ë¡ì—ì„œ ì¤‘ë³µëœ íŒŒì¼ êµì²´
          this.selectedFiles.splice(existingSelectedIndex, 1, files);
        } else {
          // ìƒˆ íŒŒì¼ ì¶”ê°€
          this.selectedFiles.push(files);
        }
      }

      // íŒŒì¼ ì„ íƒ ì»¨íŠ¸ë¡¤ ì´ˆê¸°í™”
      this.newFiles = [];
    },

    // ì„ íƒëœ íŒŒì¼ ì œê±° (ì•„ì§ ì—…ë¡œë“œë˜ì§€ ì•Šì€ íŒŒì¼)
    removeSelectedFile(index) {
      this.selectedFiles.splice(index, 1);
    },

    markFileForDeletion(index, file) {
      const exists = this.deleteFileList.some(item => item.file.seq === file.seq);

      if (!exists) {
        this.deleteFileList.push({ index, file });
      }

      this.uploadedFiles.splice(index, 1); // UIì—ì„œëŠ” ì¦‰ì‹œ ì œê±°
    },

    // ì—…ë¡œë“œëœ íŒŒì¼ ì œê±°
    async removeFile(file) {
      await apiClient.post("/api/file-attach/deleteFile", {
        seq: file.seq,
        boardSeq: this.receivedSeq,
        fileName: file.name,
        boardType: 'CA1000_10'
      });

      this.fileDelete(file.name);
    },

    // íŒŒì¼ëª… ì¤‘ë³µ í™•ì¸
    checkDuplicateFiles() {
      const duplicates = [];

      // selectedFilesì˜ ê° íŒŒì¼ì´ uploadedFilesì— ì´ë¯¸ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸
      this.selectedFiles.forEach(selectedFile => {
        const isDuplicate = this.uploadedFiles.some(uploadedFile =>
          uploadedFile.name === selectedFile.name
        );

        if (isDuplicate) {
          duplicates.push(selectedFile);
        }
      });

      return duplicates;
    },

    // íŒŒì¼ ì—…ë¡œë“œ ì²˜ë¦¬
    async uploadFiles() {
      // íŒŒì¼ ì—†ìœ¼ë©´ false ë¦¬í„´
      if (!this.selectedFiles || this.selectedFiles.length === 0) {
        return false;
      }

      // íŒŒì¼ëª… ì¤‘ë³µ í™•ì¸
      const duplicateFiles = this.checkDuplicateFiles();

      if (duplicateFiles.length > 0) {
        return false;
      }

      // ì¤‘ë³µ íŒŒì¼ì´ ì—†ìœ¼ë©´ ë°”ë¡œ ì—…ë¡œë“œ ì§„í–‰
      try {
        await this.processUpload(this.selectedFiles);
        return true; // ì„±ê³µ ì‹œ true ë¦¬í„´
      } catch (error) {
        return false; // ì‹¤íŒ¨ ì‹œ false ë¦¬í„´
      }
    },

    // ë®ì–´ì“°ê¸° ì·¨ì†Œ
    cancelOverwrite() {
      this.showOverwriteDialog = false;

      // ì¤‘ë³µë˜ì§€ ì•Šì€ íŒŒì¼ë§Œ ì—…ë¡œë“œ ì§„í–‰
      if (this.pendingFiles.length > 0) {
        this.processUpload(this.pendingFiles);
      }

      // ìƒíƒœ ì´ˆê¸°í™”
      this.duplicateFiles = [];
      this.pendingFiles = [];
    },

    // ë®ì–´ì“°ê¸° í™•ì¸
    confirmOverwrite() {
      this.showOverwriteDialog = false;

      // ì¤‘ë³µ íŒŒì¼ ì œê±° (ê¸°ì¡´ ì—…ë¡œë“œ íŒŒì¼ì—ì„œ)
      this.duplicateFiles.forEach(dupFile => {
        const index = this.uploadedFiles.findIndex(f => f.name === dupFile.name);
        if (index !== -1) {
          this.uploadedFiles.splice(index, 1);
        }
      });

      // ëª¨ë“  ì„ íƒëœ íŒŒì¼ ì—…ë¡œë“œ ì§„í–‰
      this.processUpload(this.selectedFiles);

      // ìƒíƒœ ì´ˆê¸°í™”
      this.duplicateFiles = [];
      this.pendingFiles = [];
    },


    // ì‹¤ì œ íŒŒì¼ ì—…ë¡œë“œ ì²˜ë¦¬
    async processUpload(filesToUpload) {
      if (!filesToUpload.length) throw new Error('ì—…ë¡œë“œí•  íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.');

      this.isFileLoading = true;

      try {
        // FormData ìƒì„±
        const formData = new FormData();

        // ëª¨ë“  íŒŒì¼ì„ 'files' ì´ë¦„ìœ¼ë¡œ ì¶”ê°€
        filesToUpload.forEach((file) => {
          formData.append('files', file);
        });

        // API í˜¸ì¶œ
        const response = await apiClient.post('/api/fileUpload', formData, {
          headers: {
            'Content-Type': 'multipart/form-data'
          }
        });

        // ì—…ë¡œë“œ ì„±ê³µ ì²˜ë¦¬
        if (response.data && response.data.result === 'success') {
          // console.log('íŒŒì¼ ì—…ë¡œë“œ ì„±ê³µ:', response.data);

          // ì—…ë¡œë“œ ì„±ê³µí•œ íŒŒì¼ì„ ëª©ë¡ì— ì¶”ê°€
          filesToUpload.forEach(file => {
            this.uploadedFiles.push({
              name: file.name,
              size: file.size,
              type: file.type
            });
          });

          return true;
        } else {
          throw new Error('íŒŒì¼ ì—…ë¡œë“œ ì‹¤íŒ¨');
        }
      } catch (error) {
        console.error('íŒŒì¼ ì—…ë¡œë“œ ì˜¤ë¥˜:', error);
        throw error; // í˜¸ì¶œí•œ ê³³ìœ¼ë¡œ ì—ëŸ¬ ì „íŒŒ
      } finally {
        this.isFileLoading = false;
      }
    },

    // íŒŒì¼ ì‚­ì œ í™•ì¸
    async fileDelete(para_file_name) {
      this.showDeleteDialog = false;
      this.deletingFile = para_file_name;

      try {
        // FormData ì‚¬ìš©í•˜ì§€ ì•Šê³  URLì— íŒŒë¼ë¯¸í„° í¬í•¨
        const response = await apiClient.post(`/api/fileDelete?originFile=${encodeURIComponent(this.deletingFile)}`);

        // ì‚­ì œ ì„±ê³µ ì²˜ë¦¬
        if (response.data.result === 'success') {
          // íŒŒì¼ ëª©ë¡ì—ì„œ ì‚­ì œëœ íŒŒì¼ ì œê±°
          // this.files = this.files.filter(file => file.originFile !== this.fileToDelete);

        } else {
          throw new Error(response.data.message || 'íŒŒì¼ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
      } catch (error) {
        console.error('íŒŒì¼ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', error);

      } finally {
        this.deletingFile = null;
      }
    },
    openFileSelector() {
      this.$refs.fileInput.$el.querySelector('input[type="file"]').click();
    },
  },
  computed: {
    formattedRequestDate: {
      get() {
        if (!this.inquiry.requestDate) return '';
        return dayjs(this.inquiry.requestDate).tz().format('YYYY-MM-DD');
      },
      set(val) {
        if (!val) {
          this.inquiry.requestDate = null;
        } else {
          // ì—¬ê¸°ê°€ í•µì‹¬: ë¬¸ìì—´ë¡œ ì§ì ‘ ì €ì¥ ê¸ˆì§€!
          const parsed = dayjs.tz(val, 'Asia/Seoul').toDate();
          this.inquiry.requestDate = isNaN(parsed.getTime()) ? null : parsed;
        }
      }
    },
    formattedAcceptDate: {
      get() {
        if (!this.inquiry.acceptDate) return '';
        return dayjs(this.inquiry.acceptDate).tz().format('YYYY-MM-DD');
      },
      set(val) {
        if (!val) {
          this.inquiry.acceptDate = null;
        } else {
          this.inquiry.acceptDate = dayjs.tz(val, 'Asia/Seoul').toDate();
        }
      }
    },
    formattedCompleteRequestDate: {
      get() {
        if (!this.inquiry.completeRequestDate) return '';
        return dayjs(this.inquiry.completeRequestDate).tz().format('YYYY-MM-DD');
      },
      set(val) {
        if (!val) {
          this.inquiry.completeRequestDate = null;
        } else {
          this.inquiry.completeRequestDate = dayjs.tz(val, 'Asia/Seoul').toDate();
        }
      }
    },
    formattedCompleteDate: {
      get() {
        if (!this.inquiry.completeDate) return '';
        return dayjs(this.inquiry.completeDate).tz().format('YYYY-MM-DD');
      },
      set(val) {
        if (!val) {
          this.inquiry.completeDate = null;
        } else {
          this.inquiry.completeDate = dayjs.tz(val, 'Asia/Seoul').toDate();
        }
      }
    },
  },
  created() {
    this.userInfo = JSON.parse(localStorage.getItem("userInfo"));
  },
  mounted() {
    // ìš”êµ¬ì‚¬í•­ ì •ì˜ì„œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
    this.fetchRequireDetail(); // API í˜¸ì¶œ
  },
  watch: {
    receivedSeq: {
      immediate: true  // ì»´í¬ë„ŒíŠ¸ ìƒì„± ì‹œì ì—ë„ ì¦‰ì‹œ ì‹¤í–‰
    },
  }
};
</script>

<style scoped>
.template {
  font-family: "Noto Sans KR", sans-serif;
}

/* í¼ ë””ìì¸ */
.product-category {
  display: flex;
  flex-direction: row;
  /* ê°€ë¡œ ë°©í–¥ìœ¼ë¡œ ë°°ì¹˜ */
  align-items: center;
  flex-wrap: nowrap;
  /* ì¤„ë°”ê¿ˆ ë°©ì§€ */
  width: 100%;
}

.request-period,
.product-category {
  max-width: 550px;
  flex-grow: 0;
}

.author-value {
  font-size: 14px;
  padding-left: 15px;
  white-space: nowrap;
  display: flex;
  align-items: center;
}

.title-div {
  font-size: 25px;
}

.manager-search,
.content-textarea {
  display: flex;
  justify-content: flex-start;
  align-items: flex-start;
  padding: 15px;
  width: 800px;
  height: 450px;
  font-size: 15px;
  font-weight: 400;
  overflow-y: auto;
  white-space: pre-wrap;
  word-break: break-word;
}

.search-row {
  display: flex;
  align-items: stretch;
  min-height: 50px;
  border-top: 1px solid #e0e0e0;
  border-bottom: 0;
  border-left: 1px solid #e0e0e0;
  border-right: 1px solid #e0e0e0;
  /* í•˜ë‹¨ í…Œë‘ë¦¬ ì œê±° */
}

.search-row.top-row {
  border-top: 3px solid #e0e0e0;
  border-top-left-radius: 8px;
  border-top-right-radius: 8px;
  overflow: hidden;
}

.search-row.bottom-row {
  border-bottom: 2px solid #e0e0e0;
  border-bottom-left-radius: 8px;
  border-bottom-right-radius: 8px;
  overflow: hidden;
}

/* ìƒˆë¡œ ì¶”ê°€ëœ ìŠ¤íƒ€ì¼ */
.search-row.top-row .search-col:first-child {
  border-top-left-radius: 8px;
}

.search-row.bottom-row .search-col:first-child {
  border-bottom-left-radius: 8px;
}

.search-row.top-row .search-col:last-child {
  border-top-right-radius: 8px;
}

.search-row.bottom-row .search-col:last-child {
  border-bottom-right-radius: 8px;
}

.search-col {
  display: flex;
  /* align-items: center; */
  padding: 0;
  border-left: 1px solid #e0e0e0;
}



.label-box {
  width: 80px;
  flex-shrink: 0;
  height: 100%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 14px;
  font-weight: 500;
  color: #578ADB;
  background-color: #f5f5f5;
  white-space: nowrap;
  padding: 0 4px;
  border-right: 1px solid #eaeaea;
  /* margin-bottom: 5px; */
  color: #333333 !important;
  background-color: #e6eef8 !important;
}

.save-status-btn {
  height: 42px;
  min-width: 60px;
  font-size: 14px;
  border-radius: 6px;
  margin-bottom: 15px;
}

.colNm {
  width: 140px;
}

.sub-label {
  font-weight: 500;
  font-size: 13.5px;
  border-bottom: 1px solid #e0e0e0;
  height: 35px;
  flex-shrink: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  white-space: nowrap;
  padding: 0 4px;
  border-right: 1px solid #eaeaea;
  margin-bottom: 5px;
  color: #333333 !important;
  background-color: #e6eef8 !important;
}

.custom-btn {
  font-size: 13px;
  box-shadow: none;
  border-radius: 6px;
  margin-top: -10px !important;
  margin-bottom: 15px;
  min-width: 60px;
}

.btn-container {
  display: flex;
  justify-content: flex-end;
}

.multiline-box {
  font-size: 14px;
  white-space: nowrap;
  display: flex;
  align-items: center;
  padding: 10px;
}

.input-width {
  max-width: 1600px;

  align-items: center;
}

.input-width-half {
  max-width: 797px;
  align-items: center;
}

.input-area-L {
  margin-left: 5px;
  margin-right: 5px;
  font-size: 13px !important;
}

.bottom-buttons-container {
  display: flex;
  justify-content: center;
  width: 100%;
  margin-top: 20px;
  margin-bottom: 20px;
  padding: 0 15px;
}

::v-deep(.input-area-L .v-field) {
  width: 715px;
  height: 152px !important;
  font-size: 13px !important;
}

::v-deep(.input-area-L input) {
  padding: 0 10px !important;
  font-size: 13px !important;
}

::v-deep(.date-input .v-field) {
  margin-left: 5px;
  margin-right: 5px;
  height: 33px !important;
  font-size: 15px !important;
}

::v-deep(.input-area .v-field) {
  margin-left: 5px;
  margin-right: 5px;
  height: 40px !important;
  font-size: 15px !important;
}


::v-deep(.input-area input) {
  padding: 0 10px !important;
  font-size: 13px !important;
}

/* ì²¨ë¶€íŒŒì¼ ê´€ë ¨ css */
.white-text {
  color: white !important;
}

.file-btn {
  font-size: 14px;
  height: 35px;
  border-radius: 10px;
}

.selected-files-container {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  /* ì•„ì´í…œ ì‚¬ì´ ê°„ê²© */
}

.selected-files-item {
  display: flex;
  align-items: center;
  border: 1px solid #e0e0e0;
  border-radius: 4px;
  padding: 8px 12px;
  max-width: 250px;
  /* ì›í•˜ëŠ” ë„ˆë¹„ë¡œ ì¡°ì • */
}

.file-info {
  flex-grow: 1;
  min-width: 0;
  /* í…ìŠ¤íŠ¸ ìë¥´ê¸° ìœ„í•´ í•„ìš” */
}

.file-name {
  font-weight: 500;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.file-size {
  color: #757575;
  font-size: 0.85rem;
}

.required-star {
  color: #FF0000;
  margin-right: 2px;
  font-weight: bold;
}

.date-picker {
  width: 160px;
  max-width: 160px;
}

:deep(.dp__input) {
  border: 1px solid #b0b0b0;
  box-shadow: none;
  font-size: 14px;
  border-radius: 4px;
}

:deep(.dp__main) {
  font-family: inherit;
  z-index: 100;
}

:deep(.dp__theme_light) {
  --dp-primary-color: #2196F3;
  --dp-border-radius: 8px;
}

:deep(.dp__overlay_cell_active) {
  background-color: var(--dp-primary-color);
  color: white;
}
</style>